rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isRoomMember(roomData) {
      return isAuthenticated() && request.auth.uid in roomData.members;
    }
    
    function isRoomAdmin(roomData) {
      return isAuthenticated() && request.auth.uid == roomData.createdBy;
    }
    
    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if isAuthenticated();
      
      // Users can only write their own profile
      allow write: if isOwner(userId);
    }
    
    // Rooms collection
    match /rooms/{roomId} {
      // Allow reading if:
      // - Room is public, OR
      // - User is a member of the room, OR
      // - User created the room
      allow read: if isAuthenticated() && 
        (resource.data.type == 'public' || 
         isRoomMember(resource.data) || 
         isRoomAdmin(resource.data));
      
      // Allow creating rooms if authenticated
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.members &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Allow updating if:
      // - User is admin (for all updates), OR
      // - User is joining a public room (adding themselves to members), OR
      // - User is a member updating lastMessage/lastMessageAt (when sending messages)
      allow update: if isAuthenticated() && (
        // Admin can update anything
        isRoomAdmin(resource.data) ||
        // Allow members to update lastMessage and lastMessageAt (for sending messages)
        (isRoomMember(resource.data) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastMessage', 'lastMessageAt'])) ||
        // Allow joining public rooms
        (resource.data.type == 'public' && 
         request.resource.data.members.hasAll(resource.data.members) &&
         request.resource.data.members.size() == resource.data.members.size() + 1 &&
         request.auth.uid in request.resource.data.members &&
         !(request.auth.uid in resource.data.members)) ||
        // Allow leaving rooms (removing yourself from members)
        (isRoomMember(resource.data) &&
         !request.resource.data.members.hasAny([request.auth.uid]) &&
         request.resource.data.members.size() == resource.data.members.size() - 1)
      );
      
      // Allow deleting if user is admin
      allow delete: if isAuthenticated() && isRoomAdmin(resource.data);
      
      // Join Requests subcollection
      match /joinRequests/{requestId} {
        // Anyone authenticated can read join requests in rooms they're members of
        allow read: if isAuthenticated() && isRoomMember(get(/databases/$(database)/documents/rooms/$(roomId)).data);
        
        // Anyone can create a join request
        allow create: if isAuthenticated() && 
          request.resource.data.userId == request.auth.uid;
        
        // Only room admin can update (approve/reject)
        allow update: if isAuthenticated() && isRoomAdmin(get(/databases/$(database)/documents/rooms/$(roomId)).data);
        
        // Only room admin can delete
        allow delete: if isAuthenticated() && isRoomAdmin(get(/databases/$(database)/documents/rooms/$(roomId)).data);
      }
      
      // Messages subcollection
      match /messages/{messageId} {
        // Allow reading messages if user is a member of the room
        allow read: if isAuthenticated() && isRoomMember(get(/databases/$(database)/documents/rooms/$(roomId)).data);
        
        // Allow creating messages if user is a member of the room
        allow create: if isAuthenticated() && 
          request.resource.data.senderId == request.auth.uid &&
          isRoomMember(get(/databases/$(database)/documents/rooms/$(roomId)).data);
        
        // Allow updating own messages
        allow update: if isAuthenticated() && resource.data.senderId == request.auth.uid;
        
        // Allow deleting own messages
        allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      }
    }
    
    // Presence/Status (for online/offline indicators)
    match /status/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Calls collection
    match /calls/{callId} {
      // Allow reading if user is caller or callee
      allow read: if isAuthenticated() && 
        (resource.data.callerId == request.auth.uid || 
         resource.data.calleeId == request.auth.uid);
      
      // Allow creating if user is the caller
      allow create: if isAuthenticated() && 
        request.resource.data.callerId == request.auth.uid;
      
      // Allow updating if user is caller or callee (for status changes)
      allow update: if isAuthenticated() && 
        (resource.data.callerId == request.auth.uid || 
         resource.data.calleeId == request.auth.uid);
      
      // Allow deleting if user is caller or callee
      allow delete: if isAuthenticated() && 
        (resource.data.callerId == request.auth.uid || 
         resource.data.calleeId == request.auth.uid);
      
      // Signals subcollection (for WebRTC signaling)
      match /signals/{signalId} {
        // Allow reading if user is receiver
        allow read: if isAuthenticated() && 
          request.auth.uid == resource.data.receiverId;
        
        // Allow creating if user is sender
        allow create: if isAuthenticated() && 
          request.resource.data.senderId == request.auth.uid;
        
        // Allow deleting signals
        allow delete: if isAuthenticated();
      }
    }
    
    // Call Logs collection
    match /callLogs/{logId} {
      // Allow reading if user is caller or callee
      allow read: if isAuthenticated() && 
        (resource.data.callerId == request.auth.uid || 
         resource.data.calleeId == request.auth.uid);
      
      // Allow creating call logs (typically done server-side or by call participants)
      allow create: if isAuthenticated() && 
        (request.resource.data.callerId == request.auth.uid || 
         request.resource.data.calleeId == request.auth.uid);
      
      // No updates allowed - call logs are immutable
      allow update: if false;
      
      // Allow deleting own call logs
      allow delete: if isAuthenticated() && 
        (resource.data.callerId == request.auth.uid || 
         resource.data.calleeId == request.auth.uid);
    }
  }
}
